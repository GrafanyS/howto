#### Настройка UFW

Не смотря на свое название Uncomplicated FireWall, это все таки не файрвол, а оболочка для стандартного для Linux брандмауэра iptables. А вот то, что он действительно Uncomplicated (несложный, незапутанный) это правда. 

Начнем сначала. Проверим наличие ufw:

```bash
sudo uwf status
```

Если получили сведения о состоянии, например **неактивен**, то все в порядке, двигаемся дальше. Если нет - то его необходимо установить:

```bash
sudo apt install ufw
```



Тут мне кажется необходимо сделать важную оговорку - не торопитесь его активировать, поскольку вы потеряете возможность удаленного доступа к серверу. Сначала крайне важно убедится в корректности настроек правил фильтрации.



Поскольку в планах включить поддержку IPV6 на нашем веб-сервере, то нам нужно убедится, что в нашем файрволе она включена:

Для этого откроем файл с конфигурацией:

```bash
sudo nano /etc/default/ufw
```

Нас интересует первый же параметр. Убедитесь, что и у вас он имеет значение **yes**:

```bash
IPV6=yes
```

Сохраняем и закрываем файл конфигурации. Если вы как и я используете редактор nano, то просто нажмите Ctrl+x



Итак, фильтрация.

Если вы просмотрели файл выше, то могли заметить, что по умолчанию все входящие пакеты отбрасываются:

```
DEFAULT_INPUT_POLICY="DROP"
```

Нас это не устраивает, поскольку необходимо разрешить как минимум доступ по SSH, HTTP и HTTPS.

Не торопитесь открывать файл конфигурации, он более нам не нужен. Мы сделаем это по другому. 

Помимо создания правил фильтрации непосредственно для портов или стандартных приложений прямо из командной строки UFW умеет управлять доступами для приложений с помощью  специальных файлов-конфигураций.

Список доступных приложений можно посмотреть так:

```bash
sudo ufw app list
```

Если вы двигались вместе со мной, то вы скорее всего увидите записи для **nginx**  и **openssh**, которые созданы автоматически при их обнаружении в системе. 

```bash
Available applications:
  Flask
  Nginx Full
  Nginx HTTP
  Nginx HTTPS
  OpenSSH
```



Сами файлы лежат в отдельном каталоге, давайте посмотрим его содержимое:

```bash
ls -la /etc/ufw/applications.d
```

(Либо просто откройте его через MC)

Мы опять же видим два файла **nginx**  и **openssh-server**, которые созданы автоматически при обнаружении, и содержание которых перечислила нам предыдущая команда.

Просмотрев любой из них, мы поймем, что синтаксис предельно прост:

**[Nginx HTTP]** - Название раздела. Это то, что нам покажет команда `sudo ufw app list`
**title=** - Заголовок
**description=** - Описание раздела
**ports=** - Порты, которые необходимо открыть для сервиса



Очевидно, что файл может быть один, с кучей разделов, но это не правильно, рекомендуется создавать отдельный файл для каждого сервиса.



Вооружившись этими знаниями создадим третий файл конфигурации для нашего development сервера Flask. Это будет временное разрешение, созданное для показательного примера, после запуска сервера в рабочем режиме правило должно быть отключено.

Итак, создадим пустой файл:

```bash
sudo nano /etc/ufw/applications.d/flask
```

И наполним его таким содержимым:

```bash
[Flask]
title=Flask server
description=Flask development server, do not use it on prodaction
ports=5000/tcp
```

Сохраняем, выходим. И давайте еще раз посмотрим на список приложений:

```bash
sudo ufw app list
```

И мы видим, что наше приложение Flask было добавлено в список доступных для фильтрации.

```bash
Available applications:
  Flask
  Nginx Full
  Nginx HTTP
  Nginx HTTPS
  OpenSSH
```



Но следует помнить, что добавление приложения в эти файла, не включает доступ к нему автоматически, это делается отдельной командой:

```bash
sudo ufw allow 'название сервиса'
```

Так что давайте включим некоторые правила на нашем сервере:

Первое и самое важное, повторюсь - без него, при активации UFW мы потерям возможность удаленного доступа.

```bash
sudo ufw allow OpenSSH
```

Далее разрешим порты веб-сервера:

```bash
sudo ufw allow 'Nginx Full'
```

И наш тестовый Flask

```bash
sudo ufw allow Flask
```

Обратите внимание, там где в названиях присутствовали пробелы, я использовал одинарные кавычки.



Вот теперь мы можем включить наш файрволл:

```bash
sudo ufw enable
```

Все, теперь ни один сервис кроме трех наших приложений не сможет принять подключение снаружи.



Удаляется правило аналогично:

```bash
sudo ufw delete allow 'название сервиса'
```

Либо можно получить нумерованный список правил:

```bash
sudo ufw status numbered
```

И удалить его по номеру:

```bash
sudo ufw delete номер
```



Целиком UFW можно отключить:

```bash
sudo ufw disable
```



В качестве бонуса.

Сброс настроек:

```bash
sudo ufw reset
```

Если не уверены в команде, добавьте добавьте этот ключ.

**--dry-run**

Он означает тестовый запуск, без применения реальных действий.



